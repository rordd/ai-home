<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¹ˆë²„ë“œ AIí™ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1a1a;--card:#2a2a2a;--text:#e0e0e0;--muted:#888;--accent:#FF8C00;--charcoal:#3C3C3C;--danger:#ff4444;--success:#4ecca3;--radius:16px;--shadow:0 4px 20px rgba(0,0,0,.4)}
html{font-size:clamp(14px,1.8vw,22px)}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.5rem;background:var(--charcoal);flex-shrink:0}
.header h1{font-size:1.6rem;color:var(--accent)}
.header-right{display:flex;gap:1.5rem;align-items:center;font-size:1.1rem}
.weather{display:flex;align-items:center;gap:.4rem}
.weather-icon{font-size:1.4rem}
.clock{font-variant-numeric:tabular-nums;font-weight:600}

/* Main */
.main{display:flex;flex:1;gap:1rem;padding:1rem;overflow:hidden}

/* Chat */
.chat-panel{flex:0 0 58%;display:flex;flex-direction:column;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.chat-header{padding:.7rem 1rem;font-size:1.1rem;font-weight:700;border-bottom:1px solid #444;color:var(--accent)}
.messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem}
.msg{max-width:85%;padding:.7rem 1rem;border-radius:12px;line-height:1.6;word-break:break-word;font-size:.95rem}
.msg.bot{align-self:flex-start;background:#383838;border-left:3px solid var(--accent)}
.msg.bot h3,.msg.bot h4{color:var(--accent);margin:.4rem 0 .2rem;font-size:1rem}
.msg.bot ul,.msg.bot ol{padding-left:1.2rem;margin:.3rem 0}
.msg.bot li{margin:.15rem 0}
.msg.bot strong{color:var(--accent)}
.msg.bot code{background:#2a2a2a;padding:.1rem .3rem;border-radius:4px;font-size:.9em}
.msg.user{align-self:flex-end;background:var(--accent);color:#111;font-weight:500}
.msg.loading{align-self:flex-start;background:#383838;border-left:3px solid var(--accent);color:var(--muted);font-style:italic}
.chat-input{display:flex;gap:.5rem;padding:.7rem;border-top:1px solid #444}
.chat-input input{flex:1;padding:.7rem 1rem;border:none;border-radius:10px;background:#383838;color:var(--text);font-size:1rem;outline:none}
.chat-input input:focus{box-shadow:0 0 0 2px var(--accent)}
.chat-input button{padding:.7rem 1.4rem;border:none;border-radius:10px;background:var(--accent);color:#111;font-weight:700;font-size:1rem;cursor:pointer;transition:opacity .2s}
.chat-input button:hover{opacity:.85}
.chat-input button:disabled{opacity:.4;cursor:not-allowed}

/* Right panels */
.right-panel{flex:1;display:flex;flex-direction:column;gap:1rem;overflow:hidden}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;flex:1}
.card-title{padding:.7rem 1rem;font-weight:700;font-size:1.05rem;border-bottom:1px solid #444;color:var(--accent);flex-shrink:0}
.card-body{flex:1;overflow-y:auto;padding:.8rem 1rem}

/* Fridge */
.fridge-item{display:flex;justify-content:space-between;align-items:center;padding:.45rem 0;border-bottom:1px solid #333}
.fridge-item:last-child{border:none}
.fridge-name{font-weight:600}
.fridge-qty{color:var(--muted);font-size:.85rem;margin-left:.3rem}
.fridge-dday{font-weight:700;font-size:.9rem;white-space:nowrap}
.fridge-dday.urgent{color:var(--danger);animation:pulse 1.5s infinite}
.fridge-dday.ok{color:var(--success)}
@keyframes pulse{50%{opacity:.5}}

/* Appliances */
.appliance{display:flex;align-items:center;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid #333}
.appliance:last-child{border:none}
.appliance-info{display:flex;align-items:center;gap:.6rem}
.appliance-icon{font-size:1.4rem}
.appliance-status{font-size:.85rem}
.toggle{width:3.2rem;height:1.7rem;border-radius:1rem;border:none;cursor:pointer;position:relative;transition:background .3s}
.toggle.on{background:var(--accent)}
.toggle.off{background:#555}
.toggle::after{content:'';position:absolute;top:.15rem;left:.15rem;width:1.4rem;height:1.4rem;border-radius:50%;background:#fff;transition:transform .3s}
.toggle.on::after{transform:translateX(1.5rem)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:#555;border-radius:3px}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ¦ ë¹ˆë²„ë“œ AIí™ˆ</h1>
  <div class="header-right">
    <div class="weather"><span class="weather-icon" id="wIcon">â³</span><span id="wTemp">--</span></div>
    <div class="clock" id="clock">--:--:--</div>
  </div>
</div>

<div class="main">
  <div class="chat-panel">
    <div class="chat-header">ğŸ’¬ ë¹ˆë²„ë“œ ì±„íŒ…</div>
    <div class="messages" id="messages">
      <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë¹ˆë²„ë“œ AIí™ˆì…ë‹ˆë‹¤ ğŸ¦ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>
    <div class="chat-input">
      <input id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
      <button id="sendBtn" onclick="sendChat()">ì „ì†¡</button>
    </div>
  </div>

  <div class="right-panel">
    <div class="card">
      <div class="card-title">ğŸ§Š ëƒ‰ì¥ê³  ì¬ê³ </div>
      <div class="card-body" id="fridge">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ  ê°€ì „ ìƒíƒœ</div>
      <div class="card-body" id="appliances">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.origin.includes('github.io') ? 'http://localhost:3000' : '';

// Simple markdown to HTML
function md(text) {
  if (!text) return '';
  return text
    .replace(/### (.*)/g, '<h4>$1</h4>')
    .replace(/## (.*)/g, '<h3>$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/^\d+\.\s+(.*)/gm, '<li>$1</li>')
    .replace(/^- (.*)/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, m => '<ul>' + m + '</ul>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}

// Clock
function updateClock(){
  const now=new Date();
  document.getElementById('clock').textContent=now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
}
setInterval(updateClock,1000);updateClock();

// Weather
async function fetchWeather(){
  try{
    const r=await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.55&longitude=126.85&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
    const d=await r.json();
    const t=d.current.temperature_2m;
    const wc=d.current.weather_code;
    const icons={0:'â˜€ï¸',1:'ğŸŒ¤',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ§',55:'ğŸŒ§',61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§ï¸',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'â„ï¸',80:'ğŸŒ¦',81:'ğŸŒ§',82:'â›ˆ',95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'};
    document.getElementById('wIcon').textContent=icons[wc]||'ğŸŒ¡';
    document.getElementById('wTemp').textContent=Math.round(t)+'Â°C';
  }catch(e){document.getElementById('wTemp').textContent='--'}
}
fetchWeather();setInterval(fetchWeather,600000);

// Chat
const msgBox=document.getElementById('messages');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');

chatInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}
});

function addMsg(text,type){
  const d=document.createElement('div');
  d.className='msg '+type;
  if(type==='bot') d.innerHTML=md(text);
  else d.textContent=text;
  msgBox.appendChild(d);
  msgBox.scrollTop=msgBox.scrollHeight;
  return d;
}

async function sendChat(){
  const text=chatInput.value.trim();
  if(!text)return;
  chatInput.value='';
  sendBtn.disabled=true;
  addMsg(text,'user');
  const loading=addMsg('ë¹ˆë²„ë“œê°€ ìƒê° ì¤‘...','loading');
  try{
    const r=await fetch(API_BASE+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text})});
    const d=await r.json();
    loading.remove();
    addMsg(d.reply||d.error||'ì‘ë‹µ ì—†ìŒ','bot');
  }catch(e){
    loading.remove();
    addMsg('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨','bot');
  }
  sendBtn.disabled=false;
  chatInput.focus();
}

// Fridge
async function fetchFridge(){
  try{
    const r=await fetch(API_BASE+'/api/fridge');
    const data=await r.json();
    const items=data.items||data||[];
    const el=document.getElementById('fridge');
    if(!items.length){el.innerHTML='<div style="color:var(--muted)">ì¬ê³  ì—†ìŒ</div>';return}
    el.innerHTML=items.map(i=>{
      const exp=i.expiry||i.expiryDate||null;
      let ddayStr='';
      let cls='ok';
      if(exp){
        const diff=Math.ceil((new Date(exp)-new Date())/(86400000));
        cls=diff<=3?'urgent':'ok';
        ddayStr=diff<=0?'D+'+Math.abs(diff):'D-'+diff;
      }
      return `<div class="fridge-item"><div><span class="fridge-name">${i.name}</span><span class="fridge-qty">${i.quantity||''}</span></div>${ddayStr?`<span class="fridge-dday ${cls}">${ddayStr}</span>`:''}</div>`;
    }).join('');
  }catch(e){document.getElementById('fridge').innerHTML='<div style="color:var(--muted)">ì—°ê²° ì‹¤íŒ¨</div>'}
}

// Appliances
const deviceIcons={washer:'ğŸ«§',aircon:'â„ï¸',vacuum:'ğŸ¤–',lights:'ğŸ’¡'};
const deviceNames={washer:'ì„¸íƒê¸°',aircon:'ì—ì–´ì»¨',vacuum:'ë¡œë´‡ì²­ì†Œê¸°',lights:'ì¡°ëª…'};

function isDeviceOn(key,val){
  if(key==='lights') return Object.values(val).some(r=>r.on);
  return val.status==='on'||val.status==='running'||val.status==='cleaning';
}

function deviceDetail(key,val){
  if(key==='washer') return val.status==='running'?`${val.course||'í‘œì¤€'} ${val.remainingMin}ë¶„ ë‚¨ìŒ`:(val.status==='idle'?'ëŒ€ê¸°':'ì™„ë£Œ');
  if(key==='aircon') return val.status==='on'?`${val.targetTemp}Â°C ${val.mode}`:'êº¼ì§';
  if(key==='vacuum') return val.status==='docked'?`ì¶©ì „ì¤‘ ${val.battery}%`:(val.status==='cleaning'?'ì²­ì†Œì¤‘':'ë³µê·€ì¤‘');
  if(key==='lights'){const on=Object.entries(val).filter(([,v])=>v.on).map(([k])=>k);return on.length?on.join(', ')+' ì¼œì§':'ì „ì²´ êº¼ì§'}
  return val.status||'';
}

async function fetchAppliances(){
  try{
    const r=await fetch(API_BASE+'/api/appliances');
    const data=await r.json();
    const el=document.getElementById('appliances');
    const keys=Object.keys(data).filter(k=>k!=='lastUpdated');
    if(!keys.length){el.innerHTML='<div style="color:var(--muted)">ë“±ë¡ëœ ê°€ì „ ì—†ìŒ</div>';return}
    el.innerHTML=keys.map(key=>{
      const val=data[key];
      const on=isDeviceOn(key,val);
      const icon=deviceIcons[key]||'âš¡';
      const name=val.name||deviceNames[key]||key;
      const detail=deviceDetail(key,val);
      return `<div class="appliance"><div class="appliance-info"><span class="appliance-icon">${icon}</span><div><div>${name} <span style="color:${on?'var(--accent)':'var(--muted)'}"> ${on?'ON':'OFF'}</span></div><div class="appliance-status" style="color:var(--muted)">${detail}</div></div></div><button class="toggle ${on?'on':'off'}" onclick="toggleAppliance('${key}',${!on})"></button></div>`;
    }).join('');
  }catch(e){document.getElementById('appliances').innerHTML='<div style="color:var(--muted)">ì—°ê²° ì‹¤íŒ¨</div>'}
}

async function toggleAppliance(device,state){
  try{
    await fetch(API_BASE+'/api/appliances/'+device,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({state:state?'on':'off'})});
    fetchAppliances();
  }catch(e){}
}

// Init & auto-refresh
fetchFridge();fetchAppliances();
setInterval(()=>{fetchFridge();fetchAppliances()},10000);
chatInput.focus();
</script>
</body>
</html>
